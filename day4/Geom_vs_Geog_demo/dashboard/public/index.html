<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Geospatial Day 4 — GEOMETRY vs GEOGRAPHY Dashboard</title>
  <style>
    :root { --bg: #fafaf9; --card: #fff; --border: #e7e5e4; --text: #1c1917; --text-muted: #57534e; --primary: #2563eb; --success: #15803d; --shadow: 0 1px 3px rgba(0,0,0,.08); --radius: 10px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }
    .container { max-width: 960px; margin: 0 auto; padding: 1.5rem; }
    header { background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%); color: #fff; padding: 1.25rem; border-radius: var(--radius); margin-bottom: 1.5rem; }
    header h1 { margin: 0 0 0.25rem 0; font-size: 1.5rem; }
    header p { margin: 0; opacity: .95; font-size: 0.9rem; }
    .goal { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.95rem; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .metric { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; box-shadow: var(--shadow); }
    .metric .label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 0.35rem; }
    .metric .value { font-size: 1.35rem; font-weight: 700; color: var(--text); }
    .metric.primary .value { color: var(--primary); }
    .metric.success .value { color: var(--success); }
    .btn { padding: 0.6rem 1rem; border-radius: 8px; border: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; background: var(--primary); color: #fff; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.5rem; }
    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 0.75rem 1.25rem; background: var(--text); color: #fff; border-radius: 8px; font-size: 0.9rem; z-index: 1000; opacity: 0; transition: opacity .2s; }
    .toast.show { opacity: 1; }
    .live-badge { font-size: 0.75rem; color: var(--primary); margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Geospatial Day 4 — GEOMETRY vs GEOGRAPHY</h1>
      <p>Landmarks count and distance demo (local + global). Run demo to update all metrics.</p>
    </header>
    <section class="goal">
      <strong>Metrics:</strong> Landmarks, Local distance (GEOM/GEOG), Global distance (GEOM/GEOG), Last demo ms. Auto-refresh every 3s. Use "Run demo" so values are non-zero.
    </section>
    <div class="live-badge">Last updated: <span id="last-updated">—</span></div>
    <div class="metrics">
      <div class="metric success"><div class="label">Landmarks</div><div class="value" id="metric-landmarks">—</div></div>
      <div class="metric"><div class="label">Local dist (GEOM 3857)</div><div class="value" id="metric-local-geom">—</div><div class="unit">m</div></div>
      <div class="metric"><div class="label">Local dist (GEOG 4326)</div><div class="value" id="metric-local-geog">—</div><div class="unit">m</div></div>
      <div class="metric"><div class="label">Global dist (GEOM 3857)</div><div class="value" id="metric-global-geom">—</div><div class="unit">m</div></div>
      <div class="metric"><div class="label">Global dist (GEOG 4326)</div><div class="value" id="metric-global-geog">—</div><div class="unit">m</div></div>
      <div class="metric primary"><div class="label">Last demo</div><div class="value" id="metric-execms">—</div><div class="unit">ms</div></div>
    </div>
    <div class="card">
      <h2 style="margin-top:0;">Actions</h2>
      <button class="btn" id="btn-refresh">Refresh metrics</button>
      <button class="btn" id="btn-run-demo">Run demo (distances)</button>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  <script>
    if (window.location.protocol === 'file:') {
      document.body.innerHTML = '<div style="padding:2rem;font-family:sans-serif;"><h2 style="color:#c00;">Wrong URL</h2><p>Open this dashboard at <strong>http://localhost:3004/</strong> in your browser.</p></div>';
    } else {
    (function() {
      function showToast(msg) {
        var el = document.getElementById('toast');
        if (el) { el.textContent = msg; el.classList.add('show'); setTimeout(function() { el.classList.remove('show'); }, 2500); }
      }
      function fetchJSON(path, opts) {
        var o = Object.assign({ cache: 'no-store' }, opts || {});
        return fetch(path, o).then(function(r) { if (!r.ok) throw new Error(r.statusText); return r.json(); });
      }
      function formatNum(n) {
        return (n != null && !isNaN(Number(n))) ? Number(n).toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 0 }) : '—';
      }
      var state = {
        landmarksCount: null,
        localDistGeometry: 0,
        localDistGeography: 0,
        globalDistGeometry: 0,
        globalDistGeography: 0,
        executionTimeMs: 0,
        lastUpdated: null
      };
      function render() {
        var el;
        el = document.getElementById('metric-landmarks'); if (el) el.textContent = formatNum(state.landmarksCount);
        el = document.getElementById('metric-local-geom'); if (el) el.textContent = formatNum(state.localDistGeometry);
        el = document.getElementById('metric-local-geog'); if (el) el.textContent = formatNum(state.localDistGeography);
        el = document.getElementById('metric-global-geom'); if (el) el.textContent = formatNum(state.globalDistGeometry);
        el = document.getElementById('metric-global-geog'); if (el) el.textContent = formatNum(state.globalDistGeography);
        el = document.getElementById('metric-execms'); if (el) el.textContent = formatNum(state.executionTimeMs);
        el = document.getElementById('last-updated'); if (el) el.textContent = state.lastUpdated ? state.lastUpdated.toLocaleTimeString() : '—';
      }
      function setState(next) {
        if (next.landmarksCount != null) state.landmarksCount = next.landmarksCount;
        if (next.localDistGeometry != null) state.localDistGeometry = next.localDistGeometry;
        if (next.localDistGeography != null) state.localDistGeography = next.localDistGeography;
        if (next.globalDistGeometry != null) state.globalDistGeometry = next.globalDistGeometry;
        if (next.globalDistGeography != null) state.globalDistGeography = next.globalDistGeography;
        var execMs = next.executionTimeMs != null ? next.executionTimeMs : next.lastDemoExecutionMs;
        if (execMs != null) state.executionTimeMs = execMs;
        state.lastUpdated = new Date();
        render();
      }
      var LIVE_MS = 2000, liveId = null;
      function loadStats() {
        return fetchJSON('/api/stats').then(function(s) {
          setState({
            landmarksCount: s.landmarksCount,
            localDistGeometry: s.localDistGeometry,
            localDistGeography: s.localDistGeography,
            globalDistGeometry: s.globalDistGeometry,
            globalDistGeography: s.globalDistGeography,
            executionTimeMs: s.lastDemoExecutionMs
          });
          return s;
        }).catch(function(e) { console.error('loadStats', e); });
      }
      function startLive() { if (!liveId) liveId = setInterval(function() { loadStats(); }, LIVE_MS); }
      document.getElementById('btn-refresh').addEventListener('click', function() {
        loadStats().then(function() { showToast('Metrics updated.'); }).catch(function(e) { showToast('Error: ' + (e && e.message)); });
      });
      document.getElementById('btn-run-demo').addEventListener('click', function() {
        var btn = document.getElementById('btn-run-demo');
        btn.disabled = true;
        if (liveId) { clearInterval(liveId); liveId = null; }
        fetchJSON('/api/run-demo', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
          .then(function(r) {
            setState({
              landmarksCount: r.landmarksCount,
              localDistGeometry: r.localDistGeometry,
              localDistGeography: r.localDistGeography,
              globalDistGeometry: r.globalDistGeometry,
              globalDistGeography: r.globalDistGeography,
              executionTimeMs: r.executionTimeMs
            });
            showToast('Demo ran in ' + r.executionTimeMs + ' ms.');
          })
          .catch(function(e) { showToast('Error: ' + (e && e.message)); })
          .finally(function() {
            btn.disabled = false;
            setTimeout(startLive, 500);
          });
      });
      loadStats().then(startLive).catch(startLive);
    })();
    }
  </script>
</body>
</html>
